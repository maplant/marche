{%- import "macros.html" as macros -%}
{% extends "base.html" %}

{% block title %}{{title}}{% endblock %}

{% block content %}
<script src="/static/thread.js" async></script>
<li class="menu-item" style="text-align: center; margin: 5px; padding: 10px">
  {{title}}
  <div>
    {% for tag in tags %}
    {# TODO: This should redirect to the user's preferred language #}
    <a href="/t/en/{{tag}}" style="text-decoration: none">
      <div class="tag" name="{{tag}}">{{tag}}</div>
    </a>
    {% endfor %}
  </div>
  {% if viewer_role > Role::User %}
  <div style="margin-top: 5px">
    <button onclick="togglePinned()"
            {% if pinned %}style="filter: brightness(70%)"{% endif %}
            >üìå</button>
    <button onclick="toggleLocked()"
            {% if locked %}style="filter: brightness(70%)"{% endif %}
            >üîí</button>
    <button onclick="toggleHidden()"
            {% if hidden %}style="filter: brightness(70%)"{% endif %}
            >üôà</button>
    {% if viewer_role == Role::Admin %}
    <button ondblclick="deleteThread()" type="submit" style="background: red; color: white; margin: 0px" class="action-box">
      ‚ö†Ô∏è Delete thread
    </button>
    {% endif %}
  </div>
  {% endif %}
</li>
{% for post in posts %}
{% if !post.hidden || viewer_role > Role::User %}
<li class="menu-item" id="reply-{{post.id}}"
    {% if post.hidden %}
    style="filter: brightness(70%)"
    {% endif %}
    >
  <div style="display: table" class="reply" id={{post.id}} author={{post.author.name}}>
    <div style="display: table-row">
      {% call macros::profile_stub(post.author) %}
      <div class="post">
        <div style="display: grid">
          <div style="min-height: 80px">
            {% match post.image %}
            {% when Some with (image) %}
            {% match post.thumbnail %}
            {% when Some with(thumbnail) %}
            <p><a href="{{image}}"><img src="{{thumbnail}}" title="{{post.filename}}"></a></p>
            {% when None %}
            <p><img src="{{image}}" title="{{post.filename}}"></p>
            {% endmatch %}
            {% when None %}
            {% endmatch %}
            {% if post.can_edit %}
            <form class="unparsed-{{post.id}} edit-post-form" action="/reply/{{post.id}}" method="post" threadid="{{id}}" postid="{{post.id}}" hidden>
              <div><textarea name="body" rows="12" cols="100" style="width: 100%; resize: none; box-sizing: border-box; padding: 5px">{{post.body}}</textarea></div>
              <button type="submit" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-right: 0px; margin-left: 7px; margin-bottom: 0px;">‚áí Update!</button>
              <div class="error error-{{post.id}}" style="display: none; margin-top: 15px"></div>
            </form>
            {% endif %}
            <span class="post-text">{{post.body|escape|linebreaks|e("none")}}</span>
            <p style="font-size: 80%; color: grey">Posted on {{post.date}} UTC</p>
          </div>
          <div style="display: inline">
            <div class="response-container" id="response-container-{{post.id}}"></div>
          </div>
          <div style="display: inline">
            {% for item in post.reactions %}
            {% call macros::item_thumbnail(item) %}
            {% endfor %}
          </div>
          <div style="float: right; text-align: right;">
            {% match post.reward %}
            {% when Some with (reward) %}
            <div class="rarity-{{reward.rarity}} hover-triggers-overlay" style="margin:5px;">
              ‚≠ê <b>{{reward.name}}</b> was given for this post
              <div class="overlay-on-hover item-overlay">
                {% call macros::item_overlay(reward) %}
              </div>
            </div>
            {% when None %}
            {% endmatch %}
            {% if post.can_react %}
            <a href="/react/{{post.id}}" class="react-button action-box action-box-standard-size">
              + React!
            </a>
            {% endif %}
            {% if post.can_edit %}
            <div class="edit-post-button action-box action-box-standard-size" style="margin-right: 0px" postid={{post.id}}>‚öôÔ∏è Edit!</div>
            {% endif %}
            <div class="reply-to-button action-box action-box-standard-size" style="margin-right: 0px" replyid={{post.id}}>
              + Respond!
            </div>
            {% if viewer_role > Role::User && loop.index > 1 %}
            <button id="hidden-{{post.id}}"
                    onclick="hideReply({{post.id}})"
                    type="submit"
                    class="hide-post action-box"
                    {% if post.hidden %}
                    style="filter: brightness(70%)"
                    hidden="hidden";
                    {% endif %}
                    >
              üôà
            </button>
            {% endif %}
            {% if viewer_role > Role::Moderator && loop.index > 1 %}
            <button ondblclick="deleteReply({{post.id}})" type="submit" style="background: red; color: white" class="action-box delete-reply">
              ‚ö†Ô∏è Delete reply
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</li>
{% endif %}
{% endfor %}
<form action="/thread/{{id}}" method="post" id="reply" enctype="multipart/form-data">
  <input type="hidden" id="thread_id" name="thread_id" value={{id}}>
  <li class="menu-item" style="padding: 25px">
    {% if locked %}
    <div style="display: flow-root">
      <div><textarea name="reply" id="reply-textarea" rows="12" cols="100" style="width: 100%; resize: none; box-sizing: border-box; padding: 5px" disabled></textarea></div>
      <button type="submit" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-right: 0px; margin-left: 7px; margin-bottom: 0px;" disabled>+ Reply!</button>
      <div id="error" style="margin-top: 15px">Post is locked</div>
    </div>
    {% else %}
    <div style="display: flow-root">
      <div><textarea name="body" id="reply-textarea" rows="12" cols="100" style="width: 100%; resize: none; box-sizing: border-box; padding: 5px"></textarea></div>
      <span id="attached-filename-text-container"></span>
      <button type="submit" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-right: 0px; margin-left: 7px; margin-bottom: 0px;">+ Reply!</button>
      <label id="attach-file-to-reply-button" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-bottom: 0px; margin-right: 7px;">
        <input id="attach-file-to-reply-input" style="display: none;" type="file" name="file">
        <span id="attach-file-to-reply-text-container">+ File!</span>
      </label>
      <div id="error" style="margin-top: 15px; display: none" class="error"></div>
    </div>
    {% endif %}
    <script type="text/javascript">
      {% if viewer_role >= Role::User %}
      function togglePinned() {
          var set_pinned = !{{pinned}};
          $.ajax({
              url: `/thread/{{id}}?pinned=${set_pinned}`,
              type: 'post',
              complete: function(_, _) {
                  location.href = `/thread/{{id}}`;
              }
          });
      }
      function toggleLocked() {
          var set_locked = !{{locked}};
          $.ajax({
              url: `/thread/{{id}}?locked=${set_locked}`,
              type: 'post',
              complete: function(_, _) {
                  location.href = `/thread/{{id}}`;
              }
          });
      }
      function toggleHidden() {
          var set_hidden = !{{hidden}};
          $.ajax({
              url: `/thread/{{id}}?hidden=${set_hidden}`,
              type: 'post',
              complete: function(_, _) {
                  location.href = `/thread/{{id}}`;
              }
          });
      }
      function hideReply(id, hide) {
          var hide = !$(`#hidden-${id}`).attr('hidden');
          $.ajax({
              url: `/reply/${id}?hidden=${hide}`,
              type: 'post',
              data: {
                  hidden: hide,
              },
              complete: function(_, _) {
                  if (hide) {
                      $(`#hidden-${id}`).css('filter', 'brightness(70%)');
                      $(`#hidden-${id}`).attr('hidden', true);
                      $(`#reply-${id}`).css('filter', 'brightness(70%)');
                  } else {
                      $(`#hidden-${id}`).css('filter', 'brightness(100%)');
                      $(`#hidden-${id}`).attr('hidden', false);
                      $(`#reply-${id}`).css('filter', 'brightness(100%)');
                  }
              }
          });
      }
      function deleteThread() {
          $.ajax({
              url: '/delete_thread/{{id}}',
              type: 'post',
              complete: function(_, _) {
                  location.href = '/t/en';
              }
          });
      }
      function deleteReply(id) {
          $.ajax({
              url: `/delete_reply/${id}`,
              type: 'post',
              complete: function(_, _) {
                  $(`#reply-${id}`).slideToggle();
              }
          });
      }
      {% endif %}
      // posting replies
      $(document).ready(function () {
          $("form#reply").ajaxForm({
              url: '/reply',
              type: 'post',
              success: function(response, _, _, _) {
                  if (response.error !== undefined) {
                      $("#error").html(`${response.error}`);
                      $("#error").show();
                  } else {
                      location.href = `/thread/{{id}}?jump_to=${response.ok.id}`;
                  }
              },
              error: function(_, status, error) {
                  $("#error").html("An unknown error occurred");
                  $("#error").show();
              }
          });
      });
    </script>
  </li>
</form>
{% endblock %}
