{% extends "base.html" %}

{% block title %}{{title}}{% endblock %}

{% block content %}
<script src="/static/thread.js" async></script>
<li class="menu-item" style="text-align: center; margin: 5px; padding: 10px">{{title}}
</li>
{% for post in posts %}
<li class="menu-item">
  <div style="display: table" class="reply" id={{post.id}} author={{post.author.name}}>
    <div style="display: table-row">
      <div class="profile" style="{{post.author.background}}">
        <p><a href="/profile/{{post.author.id}}" style="color: white">{{post.author.name}}</a></p>
        {% let picture = post.author.picture.as_ref() %}
        {% include "profile-pic.html" %}
        <div class="badge-grid">
          {% for badge in post.author.badges %}
            {{badge|e("none")}}
          {% endfor %}
        </div>
      </div>
      <div class="post">
        <div style="display: grid">
          <div style="min-height: 80px">
            {% match post.image %}
            {% when Some with (image) %}
            {% match post.thumbnail %}
            {% when Some with(thumbnail) %}
            <p><a href="{{image}}"><img src="{{thumbnail}}" title="{{post.filename}}"></a></p>
            {% when None %}
            <p><img src="{{image}}" title="{{post.filename}}"></p>
            {% endmatch %}
            {% when None %}
            {% endmatch %}
            {% if post.can_edit %}
            <form class="unparsed-{{post.id}} edit-post-form" action="/edit/{{post.id}}" method="post" postid="{{post.id}}" hidden>
              <div><textarea name="body" rows="12" cols="100" style="width: 100%; resize: none; box-sizing: border-box; padding: 5px">{{post.body}}</textarea></div>
              <button type="submit" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-right: 0px; margin-left: 7px; margin-bottom: 0px;">⇒ Update!</button>
              <div id="${{post.id}}-error" style="margin-top: 15px"></div>
            </form>
            {% endif %}
            <span class="parsed-{{post.id}}">{{post.body_html|e("none")}}</span>
            <p style="font-size: 80%; color: grey">Posted on {{post.date}} UTC</p>
          </div>
          <div style="display: inline">
            <div class="response-container" id="response-container-{{post.id}}"></div>
          </div>
          <div style="display: inline">
            {% for item in post.reactions %}
              {% include "item-thumbnail.html" %}
            {% endfor %}
          </div>
          <div style="float: right; text-align: right;">
            {% match post.reward %}
            {% when Some with (reward) %}
            <div class="rarity-{{reward.rarity}} hover-triggers-overlay" style="margin:5px;">
              ⭐ <b>{{reward.name}}</b> was given for this post
              <div class="overlay-on-hover item-overlay">
                {% let item = reward %}
                {% include "item-overlay.html" %}
              </div>
            </div>
            {% when None %}
            {% endmatch %}
            {% if post.can_react %}
            <a href="/react/{{post.id}}" class="react-button action-box action-box-standard-size">
              + React!
            </a>
            {% endif %}
            {% if post.can_edit %}
            <div class="edit-post-button action-box action-box-standard-size" style="margin-right: 0px" postid={{post.id}}>⚙️ Edit!</div>
            {% endif %}
            <div class="reply-to-button action-box action-box-standard-size" style="margin-right: 0px" replyid={{post.id}}>
              + Respond!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</li>
{% endfor %}
<form action="/thread/{{id}}" method="post" id="reply" enctype="multipart/form-data">
  <li class="menu-item" style="padding: 25px">
    <div style="display: flow-root">
      <div><textarea name="reply" id="reply-textarea" rows="12" cols="100" style="width: 100%; resize: none; box-sizing: border-box; padding: 5px"></textarea></div>
      <span id="attached-filename-text-container"></span>
      <button type="submit" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-right: 0px; margin-left: 7px; margin-bottom: 0px;">+ Reply!</button>
      <label id="attach-file-to-reply-button" class="action-box action-box-standard-size" style="float: right; margin-top: 15px; margin-bottom: 0px; margin-right: 7px;">
        <input id="attach-file-to-reply-input" style="display: none;" type="file" name="file">
        <span id="attach-file-to-reply-text-container">+ File!</span>
      </label>
      <div id="error" style="margin-top: 15px"></div>
    </div>
    <script>
      $(document).ready(function () {       
          $("form").ajaxForm({
              url: '/thread/{{id}}',
              type: 'post',
              success: function(response, _, _, _) {
                  if (response.error !== undefined) {
                      $("#error").html(`<div class="error" id="error">${response.error}</div>`)
                  } else if (response.id !== undefined) {
                      location.href = `/thread/{{id}}?jump_to=${response.id}`;
                  }
              },
              error: function(_, status, error) {
                  $("#error").html(`<div class="error" id="error">Unable to upload image</div>`)
              }
          });
      });
    </script>
  </li>
</form>
{% endblock %}
